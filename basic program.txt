C'est un plan très clair. Nous avons maintenant toutes les pièces du puzzle pour définir l'architecture **SaaS Multi-tenant MERN** hébergée sur **AWS**.

Le fait de passer en "Bring Your Own Twilio" (BYO) et d'utiliser Grok simplifie certaines parties mais demande une architecture de base de données rigoureuse pour bien séparer les données des entreprises (Multi-tenancy).

Voici le **Plan de Travail Complet et Technique** pour le développement.

---

### Phase 1 : Architecture & Base de Données (Fondations)

C'est l'étape la plus critique. Comme c'est un SaaS, nous devons isoler les données de chaque entreprise via un `tenant_id`.

**1.1. Modélisation des Données (MongoDB Atlas)**
Nous allons créer 4 collections principales.

* **Tenants (Entreprises)**
    * `_id`: ObjectId
    * `companyName`: String
    * `subscriptionStatus`: String (Active, Trial, Cancelled)
    * `settings`: { `slaHours`: 24, `language`: "fr" }
    * `twilioConfig`: { `accountSid`: String, `authToken`: String (Encrypted), `phoneNumbers`: [String] } // Support multi-numéros

* **Users (Utilisateurs & Managers)**
    * `_id`: ObjectId
    * `tenant_id`: Link to Tenants **(Crucial)**
    * `email`: String
    * `password`: String (Hashed via bcrypt)
    * `role`: Enum ["Admin", "Manager", "Employee"]
    * `outlookConfig`: { `accessToken`: String, `refreshToken`: String, `expiry`: Date } // Token personnel

* **Communications (Le cœur du système)**
    * `_id`: ObjectId
    * `tenant_id`: Link to Tenants
    * `source`: Enum ["Outlook", "WhatsApp"]
    * `externalId`: String (MessageID Outlook ou WhatsApp)
    * `content`: String (Texte brut)
    * `attachments`: [{ `url`: String, `type`: String, `analysis`: String }] // Stockés sur AWS S3
    * `ai_analysis`: {
        * `summary`: String
        * `sentiment`: String (Positive, Neutral, Negative)
        * `suggestedAction`: String
        * `category`: String
    }
    * `status`: Enum ["To Validate", "Validated", "Escalated", "Closed"]
    * `receivedAt`: Date
    * `slaDueDate`: Date (receivedAt + 24h)

* **Notifications (Pour le Dashboard Manager)**
    * `recipient_id`: Link to User (Manager)
    * `type`: "SLA_BREACH"
    * `communication_id`: Link to Communication
    * `isRead`: Boolean

---

### Phase 2 : Backend (Node.js/Express sur AWS EC2)

**2.1. Authentification & Sécurité**
* Mise en place de **Passport.js** (Local Strategy) pour email/password.
* Génération de **JWT (JSON Web Token)** contenant le `tenant_id` et le `role`.
* Middleware `checkRole` : Assure qu'un employé ne voit pas le Dashboard Manager.

**2.2. Intégration Outlook (Graph API)**
* Créer un endpoint OAuth `/auth/microsoft` pour que chaque employé connecte sa boîte.
* Job de synchronisation (Polling) : Toutes les X minutes, récupérer les nouveaux emails.
* **Traitement PJ** : Télécharger les PJ -> Upload sur **AWS S3** -> Extraire texte (si PDF/Docx) -> Envoyer à Grok.

**2.3. Intégration WhatsApp (Twilio Multi-Compte)**
* Endpoint Webhook unique : `POST /api/webhooks/whatsapp`.
* **Logique de routage** : Quand Twilio envoie un message, on regarde le champ `To` (numéro de destination) -> On cherche dans la collection `Tenants` à quelle entreprise appartient ce numéro -> On enregistre le message avec le bon `tenant_id`.

**2.4. Le Cerveau IA (Grok API)**
* Créer un service `AiService.js`.
* **Prompt Engineering** :
    > "Tu es un assistant business. Analyse ce message et les pièces jointes.
    > Sortie JSON attendue : { "summary": "...", "sentiment": "...", "action_needed": "...", "urgency": "..." }"
* Appeler Grok à chaque nouveau message entrant.

**2.5. Le Cron Job SLA (Node.js)**
* Utiliser `node-cron` ou `BullMQ`.
* **Logique :** Toutes les 15 min, chercher dans `Communications` les items où `status != "Closed"` ET `slaDueDate < Date.now()`.
* **Action :** Passer `status` à "Escalated" et créer une alerte dans `Notifications`.

---

### Phase 3 : Frontend (React - Vue Kanban)

**3.1. Dashboard Manager (Vue Kanban)**
Nous utiliserons `@dnd-kit` ou `react-beautiful-dnd`.
* **Colonnes :** "À Valider (IA)", "En Cours", "Escaladé (Retard)", "Terminé".
* **Cartes :** Chaque carte affiche le Résumé IA + Sentiment (icône couleur) + Timer (compte à rebours SLA).
* **Consultation seulement :** Le manager voit l'info. S'il clique, il voit le détail (message original + PJ), mais il ne répond pas depuis l'outil (conformément à ta demande). Il peut juste "Valider" que l'info est vue.

**3.2. Dashboard KPIs (Reporting)**
* Utilisation de **Recharts**.
* **Graphiques :**
    1.  BarChart : Volume WhatsApp vs Outlook.
    2.  LineChart : Temps de réponse moyen (Évolution sur 7 jours).
    3.  PieChart : Sentiment Analysis (Positif/Négatif).

**3.3. Configuration Entreprise**
* Page pour entrer les credentials Twilio (Account SID, Token).
* Page pour inviter les employés (création de comptes User).

---

### Phase 4 : Infrastructure AWS & Déploiement

**4.1. Stockage (AWS S3)**
* Créer un Bucket S3 privé pour stocker les pièces jointes des emails/WhatsApp de manière sécurisée.

**4.2. Base de données (MongoDB Atlas)**
* Cluster M10 (ou supérieur pour la prod) avec backups automatisés.
* Whitelisting des IP du serveur AWS.

**4.3. Serveur d'Application (AWS EC2 ou Elastic Beanstalk)**
* Pour commencer simple : Une instance **EC2 (Ubuntu)** avec Docker.
* Nginx comme Reverse Proxy (gestion SSL via Certbot).
* PM2 pour gérer le processus Node.js en production.

---

### Phase 5 : Planification des Sprints

Voici comment nous allons exécuter cela semaine par semaine :

* **Sprint 1 : Setup & Auth (Semaine 1)**
    * Setup AWS & MongoDB Atlas.
    * Création des modèles Mongoose (Tenant, User).
    * API Login/Register & Middleware JWT.
    * UI React : Page de Login.

* **Sprint 2 : Connecteurs & Ingestion (Semaine 2)**
    * API Twilio Webhook (Gestion multi-tenant).
    * API Outlook OAuth & Polling simple.
    * Upload S3 des pièces jointes.

* **Sprint 3 : Intelligence IA avec Grok (Semaine 3)**
    * Intégration API Grok.
    * Pipeline : Message -> Texte + PJ -> Prompt -> JSON -> DB.
    * UI : Liste brute des messages reçus.

* **Sprint 4 : Dashboard Kanban & SLA (Semaine 4)**
    * UI : Intégration du Kanban React.
    * Backend : Logic Cron Job 24h & Notifications.
    * Logique de validation du résumé par l'humain.

* **Sprint 5 : KPIs & Finalisation (Semaine 5)**
    * UI : Page de Statistiques (Recharts).
    * Tests de charge (Simulation de plusieurs entreprises).
    * Déploiement final sur AWS.

### Prochaine étape immédiate pour toi :
Dois-je commencer par te générer le **code du Backend (Schema Mongoose + Endpoint Twilio Multi-tenant)** ou préfères-tu voir la **maquette (Wireframe) du Kanban** en premier ?